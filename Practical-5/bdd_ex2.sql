-- MySQL Script generated by MySQL Workbench
-- Tue May  9 10:44:53 2023
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

-- -----------------------------------------------------
-- Table `tp5_part2`.`Livre`
-- -----------------------------------------------------

CREATE TABLE IF NOT EXISTS `Livre` (
  `idLivre` INT NOT NULL,
  `nomLivre` VARCHAR(45) NULL,
  `auteur` VARCHAR(45) NULL,
  `importance` INT NULL DEFAULT 1,
  PRIMARY KEY (`idLivre`))
;


-- -----------------------------------------------------
-- Table `tp5_part2`.`Année`
-- -----------------------------------------------------

CREATE TABLE IF NOT EXISTS `Annee` (
  `idAnnee` INT NOT NULL,
  PRIMARY KEY (`idAnnee`))
;


-- -----------------------------------------------------
-- Table `tp5_part2`.`Enseignant`
-- -----------------------------------------------------

CREATE TABLE IF NOT EXISTS `Enseignant` (
  `idEnseignant` INT NOT NULL,
  `nomEns` VARCHAR(45) NULL,
  `prenomEns` VARCHAR(45) NULL,
  PRIMARY KEY (`idEnseignant`))
;


-- -----------------------------------------------------
-- Table `tp5_part2`.`Cours`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `Cours` ;

CREATE TABLE IF NOT EXISTS `Cours` (
  `idCours` INT NOT NULL,
  `Enseignant_idEnseignant` INT NOT NULL,
  PRIMARY KEY (`idCours`))
;

CREATE INDEX `fk_Cours_Enseignant_idx` ON `Cours` (`Enseignant_idEnseignant` ASC);


-- -----------------------------------------------------
-- Table `tp5_part2`.`Parcours`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `Parcours` ;

CREATE TABLE IF NOT EXISTS `Parcours` (
  `idParcours` INT NOT NULL,
  PRIMARY KEY (`idParcours`))
;


-- -----------------------------------------------------
-- Table `tp5_part2`.`Cours_has_Livre`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `Cours_has_Livre` ;

CREATE TABLE IF NOT EXISTS `Cours_has_Livre` (
  `Cours_idCours` INT NOT NULL,
  `Livre_idLivre` INT NOT NULL,
  PRIMARY KEY (`Cours_idCours`, `Livre_idLivre`))
;

CREATE INDEX `fk_Cours_has_Livre_Livre1_idx` ON `Cours_has_Livre` (`Livre_idLivre` ASC);

CREATE INDEX `fk_Cours_has_Livre_Cours1_idx` ON `Cours_has_Livre` (`Cours_idCours` ASC);


-- -----------------------------------------------------
-- Table `tp5_part2`.`Année_has_Livre`
-- -----------------------------------------------------

CREATE TABLE IF NOT EXISTS `Annee_has_Livre` (
  `Annee_idAnnee` INT NOT NULL,
  `Livre_idLivre` INT NOT NULL,
  PRIMARY KEY (`Annee_idAnnee`, `Livre_idLivre`))
;

CREATE INDEX `fk_Annee_has_Livre_Livre1_idx` ON `Annee_has_Livre` (`Livre_idLivre` ASC);

CREATE INDEX `fk_Annee_has_Livre_Année1_idx` ON `Annee_has_Livre` (`Annee_idAnnee` ASC);


-- -----------------------------------------------------
-- Table `tp5_part2`.`Parcours_has_Cours`
-- -----------------------------------------------------

CREATE TABLE IF NOT EXISTS `Parcours_has_Cours` (
  `Parcours_idParcours` INT NOT NULL,
  `Cours_idCours` INT NOT NULL,
  PRIMARY KEY (`Parcours_idParcours`, `Cours_idCours`))
;

CREATE INDEX `fk_Parcours_has_Cours_Cours1_idx` ON `Parcours_has_Cours` (`Cours_idCours` ASC);

CREATE INDEX `fk_Parcours_has_Cours_Parcours1_idx` ON `Parcours_has_Cours` (`Parcours_idParcours` ASC);

-- -----------------------------------------------------
-- Trigger pour l'importance du livre
-- -----------------------------------------------------

CREATE TRIGGER importanceLivre 
AFTER INSERT ON Cours_has_Livre
BEGIN
UPDATE Livre SET importance = importance + 1
WHERE idLivre = NEW.Livre_idLivre;
END;

CREATE TABLE Modifications (id INTEGER PRIMARY KEY AUTOINCREMENT, lastModif DATE);

CREATE TRIGGER 'DernièreModif'
AFTER UPDATE ON Livre
FOR EACH ROW
BEGIN
  INSERT INTO Modifications(lastModif) VALUES (datetime('now'));
END;

CREATE VIEW IF NOT EXISTS LivresView(nom_Livre) AS SELECT nomLivre FROM Livre;

CREATE TRIGGER update_view
INSTEAD OF INSERT ON LivresView
FOR EACH ROW
BEGIN
  INSERT INTO Livre (idLivre, nomLivre, auteur) VALUES (NEW.idLivre, NEW.nomLivre, NEW.auteur);
END;

UPDATE Livre SET nomLivre = 'JECHANGE'
WHERE idLivre=10;


-- -----------------------------------------------------
-- Insertion des données
-- -----------------------------------------------------

INSERT INTO Livre (idLivre, nomLivre, auteur) VALUES (10, 'nomlivre0', 'auteur0');
INSERT INTO Livre (idLivre, nomLivre, auteur) VALUES (11, 'nomlivre1', 'auteur1');
INSERT INTO Livre (idLivre, nomLivre, auteur) VALUES (12, 'nomlivre2', 'auteur2');
INSERT INTO Livre (idLivre, nomLivre, auteur) VALUES (13, 'nomlivre3', 'auteur3');

INSERT INTO Enseignant (idEnseignant, nomEns, prenomEns) VALUES (20, 'nomEns0', 'prenomEns0');
INSERT INTO Enseignant (idEnseignant, nomEns, prenomEns) VALUES (21, 'nomEns1', 'prenomEns1');
INSERT INTO Enseignant (idEnseignant, nomEns, prenomEns) VALUES (22, 'nomEns2', 'prenomEns2');
INSERT INTO Enseignant (idEnseignant, nomEns, prenomEns) VALUES (23, 'nomEns3', 'prenomEns3');

INSERT INTO Cours (idCours, Enseignant_idEnseignant) VALUES (30, 20);
INSERT INTO Cours (idCours, Enseignant_idEnseignant) VALUES (31, 20);
INSERT INTO Cours (idCours, Enseignant_idEnseignant) VALUES (32, 21);
INSERT INTO Cours (idCours, Enseignant_idEnseignant) VALUES (33, 22);

INSERT INTO Parcours (idParcours) VALUES (40);
INSERT INTO Parcours (idParcours) VALUES (41);
INSERT INTO Parcours (idParcours) VALUES (42);
INSERT INTO Parcours (idParcours) VALUES (43);

INSERT INTO Annee (idAnnee) VALUES (2020);
INSERT INTO Annee (idAnnee) VALUES (2021);
INSERT INTO Annee (idAnnee) VALUES (2022);
INSERT INTO Annee (idAnnee) VALUES (2023);

INSERT INTO Cours_has_Livre (Cours_idCours, Livre_idLivre) VALUES (30, 10);
INSERT INTO Cours_has_Livre (Cours_idCours, Livre_idLivre) VALUES (31, 11);
INSERT INTO Cours_has_Livre (Cours_idCours, Livre_idLivre) VALUES (32, 10);
INSERT INTO Cours_has_Livre (Cours_idCours, Livre_idLivre) VALUES (33, 12);

INSERT INTO Parcours_has_Cours (Parcours_idParcours, Cours_idCours) VALUES (40, 30);
INSERT INTO Parcours_has_Cours (Parcours_idParcours, Cours_idCours) VALUES (41, 32);
INSERT INTO Parcours_has_Cours (Parcours_idParcours, Cours_idCours) VALUES (42, 33);
INSERT INTO Parcours_has_Cours (Parcours_idParcours, Cours_idCours) VALUES (40, 31);

INSERT INTO Annee_has_Livre (Annee_idAnnee, Livre_idLivre) VALUES (2020, 10);
INSERT INTO Annee_has_Livre (Annee_idAnnee, Livre_idLivre) VALUES (2020, 11);
INSERT INTO Annee_has_Livre (Annee_idAnnee, Livre_idLivre) VALUES (2021, 12);
INSERT INTO Annee_has_Livre (Annee_idAnnee, Livre_idLivre) VALUES (2022, 13);
